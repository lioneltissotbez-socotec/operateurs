<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard OpÃ©rateurs â€“ Certifications</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6fa; margin:0; padding:20px; }
  h1 { margin:0; }
  .container {
  width: 90%;
  max-width: 1200px;
  margin:auto;
}


  input[type="file"] { margin:10px 0 15px; }

  /* Header avec logo */
  .header {
    display:flex;
    align-items:center;
    gap:20px;
    margin-bottom:10px;
  }
  .header-logo {
    height:48px;
    width:auto;
  }
  @media (max-width:600px){
    .header {
      flex-direction:column;
      text-align:center;
    }
    .header-logo {
      height:40px;
    }
  }

/* Bouton moderne pour ouvrir le fichier */
.file-button-wrapper {
  margin: 15px 0;
  position: relative;
}

#excelFile {
  display: none; /* on cache l'input natif */
}

#openFileBtn {
  padding: 10px 20px;
  background: #0078d4;
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  transition: 0.2s;
}

#openFileBtn:hover {
  background: #005fa3;
  box-shadow: 0 5px 12px rgba(0,0,0,0.25);
}


  /* Barre de chargement */
  #loadingBarWrapper {
    width:100%; background:#ddd; border-radius:20px; height:14px;
    margin:15px 0; display:none; overflow:hidden;
  }
  #loadingBar {
    height:100%; width:0; background:#4a90e2;
    border-radius:20px; transition:width .4s;
  }

  /* --- BARRE DE FILTRES MODERNE --- */
  .filters-card {
    background: white;
    padding: 18px 22px;
    border-radius: 14px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    margin: 10px 0 20px;
  }

  .filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 18px 30px;
    align-items: center;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    font-size: 13px;
  }

  .filter-group label {
    font-weight: bold;
    margin-bottom: 4px;
  }

  .filters select {
    appearance: none;
    padding: 7px 35px 7px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #fff;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23000" height="14" viewBox="0 0 20 20" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M5.516 7.548L10 12.032l4.484-4.484L16 8.064l-6 6-6-6z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    cursor: pointer;
  }

  .filters button {
    padding: 8px 18px;
    background: #0078d4;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: 0.2s;
  }

  .filters button:hover {
    background: #005fa3;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  @media (max-width: 700px) {
    .filters-row {
      flex-direction: column;
      align-items: stretch;
    }
  }

  /* KPI */
  .kpi-card {
  background:white;
  padding:22px 26px;
  border-radius:14px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
  margin-bottom:25px;
  border-left:5px solid #0078d4;
}

.kpi-section-title {
  font-weight:600;
  font-size:14px;
  color:#005fa3;
  text-transform:uppercase;
  letter-spacing:0.4px;
  margin-bottom:4px;
}

.kpi-row {
  display:flex;
  gap:30px;
  flex-wrap:wrap;
  font-size:14px;
  padding-left:4px;
}

.kpi-row span b {
  color:#222;
}


  /* Graph */
  #chartContainer {
  background:white; padding:20px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:30px;
  display:none; /* ðŸ‘ˆ masquÃ© par dÃ©faut */
}


  /* Tableau */
  table {
    width: 90%;              /* MODIFIÃ‰ */
    margin: auto;            /* AJOUTÃ‰ */
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

  th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:13px; }
  th { background:#fafafa; cursor:pointer; }
  th:hover { background:#ececec; }

  .cell-content { display:flex; align-items:center; gap:6px; }
  .dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
  .valid { background:#2ecc71; }
  .expired { background:#e74c3c; }
  .none { background:#bdc3c7; }

  .cert-org {
    font-size:11px; padding:2px 6px; border-radius:4px;
    max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .cert-org.valid { background:#e8f8f0; color:#1e8449; }
  .cert-org.expired { background:#fdecea; color:#c0392b; }
  .cert-org.none { background:#ecf0f1; color:#7f8c8d; }

.kpi-card {
  background:white;
  padding:18px 22px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  margin-bottom:25px;
}

.kpi-section-title {
  font-weight:bold;
  font-size:15px;
  color:#005fa3;
  margin-bottom:6px;
}

.kpi-row {
  display:flex;
  gap:25px;
  flex-wrap:wrap;
  font-size:14px;
}

/* --- KPI sur une seule ligne --- */
.kpi-container {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  margin: 20px 0 30px;
}

.kpi-card {
  flex: 1;
  background: white;
  padding: 20px 22px;
  border-radius: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-left: 5px solid #0078d4;
  min-width: 280px;
}

.kpi-title {
  font-weight: 700;
  font-size: 15px;
  color: #005fa3;
  margin-bottom: 10px;
  text-transform: uppercase;
}

.kpi-line {
  font-size: 15px;
  margin: 6px 0;
  display: flex;
  justify-content: space-between;
}

.kpi-value {
  font-weight: bold;
  color: #222;
}

/* Responsive */
@media (max-width: 900px) {
  .kpi-container {
    flex-direction: column;
  }
}


  /* Modal export visuel */
  #exportModal {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.45); display:none;
    align-items:center; justify-content:center; z-index:9999;
  }
  #exportModal .modal-inner {
    background:white; padding:20px; border-radius:12px;
    width:90%; max-width:none; max-height:85%; overflow:auto;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
  }
  #exportModal h2 {
    margin-top:0;
  }
  #exportModal table {
    box-shadow:none;
  }
  #exportModal button {
    margin-top:10px;
    margin-right:8px;
  }
  #exportModal button {
  padding: 6px 14px;
  background: #0078d4;
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 13px;
  margin-left: 6px;
}

#exportModal button:hover {
  background:#005fa3;
}
/* Recherche opÃ©rateur */
#searchOperator {
  padding: 7px 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 5px;
}

#searchOperatorSelect {
  padding: 7px 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
#toggleChart {
  width: 16px;
  height: 16px;
  cursor: pointer;
}


</style>
</head>
<body>
<div class="container">

  <div class="header">
    <img src="https://raw.githubusercontent.com/lioneltissotbez-socotec/socotec-assets/8b85d1f9144eefe32a8ddca9516b8d8583d7bbbd/logo.svg"
         alt="Logo SOCOTEC" class="header-logo">
    <h1>Dashboard des opÃ©rateurs â€“ Certifications</h1>
  </div>

  <div class="file-button-wrapper">
  <button id="openFileBtn">Ouvrir le fichier opÃ©rateurs</button>
  <input type="file" id="excelFile" accept=".xlsx" />
</div>


  <!-- Filtres modernisÃ©s -->
 <div class="filters-card filters">
  <div class="filters-row">

      <div class="filter-group">
        <label for="filterExpiry">Expiration</label>
        <select id="filterExpiry">
          <option value="0">Tous</option>
          <option value="1">1 mois</option>
          <option value="3">3 mois</option>
          <option value="6">6 mois</option>
          <option value="12">12 mois</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filterCert">Certificateur</label>
        <select id="filterCert">
          <option value="ALL">Tous</option>
        </select>
      </div>

      <!-- ðŸ” NOUVEAU : recherche opÃ©rateur -->
      <div class="filter-group">
        <label for="searchOperator">OpÃ©rateur</label>
        <input type="text" id="searchOperator" placeholder="Nom ou prÃ©nomâ€¦" />
        <select id="searchOperatorSelect">
          <option value="ALL">Tous</option>
        </select>
      </div>
      <!-- fin nouveau bloc -->

      <div class="filter-group">
        <label for="graphMode">Graphique</label>
        <select id="graphMode">
          <option value="domain">Domaines</option>
          <option value="cert">Certificateurs</option>
        </select>
      </div>

<div class="filter-group" style="margin-top:22px;">
  <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
    <input type="checkbox" id="toggleChart" />
    Afficher le graphique
  </label>
</div>


      <div class="filter-group">
        <label style="opacity:0;">.</label>
        <button id="exportVisualBtn">Exporter visuel</button>
      </div>

  </div>
</div>


  <div id="loadingBarWrapper"><div id="loadingBar"></div></div>

  <!-- KPI -->
  <div class="kpi-container">

  <!-- Bloc 1 : OpÃ©rateurs -->
  <div class="kpi-card">
    <div class="kpi-title">OpÃ©rateurs</div>
    <div class="kpi-line">Globaux <span class="kpi-value" id="kpiTotal">â€“</span></div>
    <div class="kpi-line">FiltrÃ©s <span class="kpi-value" id="kpiFilteredTotal">â€“</span></div>
  </div>

  <!-- Bloc 2 : ExpirÃ©s -->
  <div class="kpi-card">
    <div class="kpi-title">ExpirÃ©s</div>
    <div class="kpi-line">Globaux <span class="kpi-value" id="kpiExpired">â€“</span></div>
    <div class="kpi-line">FiltrÃ©s <span class="kpi-value" id="kpiFilteredExpired">â€“</span></div>
  </div>

  <!-- Bloc 3 : Socle complet -->
  <div class="kpi-card">
    <div class="kpi-title">Socle complet</div>
    <div class="kpi-line">Globaux <span class="kpi-value" id="kpiFull">â€“</span></div>
    <div class="kpi-line">FiltrÃ©s <span class="kpi-value" id="kpiFilteredFull">â€“</span></div>
  </div>

</div>




  <div id="chartContainer">
    <canvas id="chart"></canvas>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>OpÃ©rateur</th>
        <th data-domain="amiante">Amiante</th>
        <th data-domain="crep">CREP</th>
        <th data-domain="term">Termites</th>
        <th data-domain="dpem">DPE Mention</th>
        <th data-domain="gaz">Gaz</th>
        <th data-domain="elec">Ã‰lec</th>
        <th data-domain="dpei">DPE Indiv</th>
        <th data-domain="audit">Audit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- MODAL EXPORT VISUEL -->
<div id="exportModal">
  <div class="modal-inner">
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h2 style="margin:0;">Export des opÃ©rateurs filtrÃ©s</h2>

      <div>
        <button id="copyExportBtn">Copier</button>
        <button id="closeExportBtn">Fermer</button>
      </div>
    </div>

    <div id="exportTableContainer"></div>

  </div>
</div>


<script>
/* ==========
   Utilitaires dates
   ========== */

function parseExcelDate(v) {
  if (!v) return null;

  if (v instanceof Date) return v;

  if (typeof v === "number") {
    const d = XLSX.SSF.parse_date_code(v);
    if (!d) return null;
    return new Date(d.y, d.m - 1, d.d);
  }

  if (typeof v === "string") {
    const parts = v.split("/");
    if (parts.length === 3) {
      const [dd, mm, yyyy] = parts.map(n => parseInt(n));
      if (!isNaN(dd) && !isNaN(mm) && !isNaN(yyyy)) {
        return new Date(yyyy, mm - 1, dd);
      }
    }
  }
  return null;
}

function isValidDate(dateFin) {
  const d = parseExcelDate(dateFin);
  if (!d) return false;
  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  return d >= today;
}

/* ==========
   Config colonnes / domaines
   ========== */

const COL = {
  NAME:1,

  AMI_CERT:10, AMI_NUM:11, AMI_DEB:12, AMI_FIN:13,
  CREP_CERT:15, CREP_NUM:16, CREP_DEB:17, CREP_FIN:18,
  TERM_CERT:20, TERM_NUM:21, TERM_DEB:22, TERM_FIN:23,
  DPEM_CERT:25, DPEM_NUM:26, DPEM_DEB:27, DPEM_FIN:28,
  GAZ_CERT:30, GAZ_NUM:31, GAZ_DEB:32, GAZ_FIN:33,
  ELEC_CERT:35, ELEC_NUM:36, ELEC_DEB:37, ELEC_FIN:38,
  DPEI_CERT:42, DPEI_NUM:43, DPEI_DEB:44, DPEI_FIN:45,
  AUDIT:48
};

const DOMAINS = [
  {label:"Amiante",     key:"amiante", isCore:true,
    cert:COL.AMI_CERT,  num:COL.AMI_NUM,  deb:COL.AMI_DEB,  fin:COL.AMI_FIN},
  {label:"CREP",        key:"crep",    isCore:true,
    cert:COL.CREP_CERT, num:COL.CREP_NUM, deb:COL.CREP_DEB, fin:COL.CREP_FIN},
  {label:"Termites",    key:"term",    isCore:true,
    cert:COL.TERM_CERT, num:COL.TERM_NUM, deb:COL.TERM_DEB, fin:COL.TERM_FIN},
  {label:"DPE Mention", key:"dpem",    isCore:true,
    cert:COL.DPEM_CERT, num:COL.DPEM_NUM, deb:COL.DPEM_DEB, fin:COL.DPEM_FIN},
  {label:"Gaz",         key:"gaz",     isCore:true,
    cert:COL.GAZ_CERT,  num:COL.GAZ_NUM,  deb:COL.GAZ_DEB,  fin:COL.GAZ_FIN},
  {label:"Ã‰lec",        key:"elec",    isCore:true,
    cert:COL.ELEC_CERT, num:COL.ELEC_NUM, deb:COL.ELEC_DEB, fin:COL.ELEC_FIN},
  {label:"DPE Indiv",   key:"dpei",    isCore:false,
    cert:COL.DPEI_CERT, num:COL.DPEI_NUM, deb:COL.DPEI_DEB, fin:COL.DPEI_FIN},
  {label:"Audit",       key:"audit",   isCore:false,
    audit:COL.AUDIT}
];

/* ==========
   RÃ©fÃ©rences DOM et variables globales
   ========== */

const fileInput = document.getElementById("excelFile");
const filterSelect = document.getElementById("filterExpiry");
const filterCertSelect = document.getElementById("filterCert");
const graphModeSelect = document.getElementById("graphMode");
const loadingBarWrapper = document.getElementById("loadingBarWrapper");
const loadingBar = document.getElementById("loadingBar");
const tbody = document.querySelector("#dataTable tbody");
const kpiTotal = document.getElementById("kpiTotal");
const kpiExpired = document.getElementById("kpiExpired");
const kpiFull = document.getElementById("kpiFull");
const chartCanvas = document.getElementById("chart");
const exportVisualBtn = document.getElementById("exportVisualBtn");
const exportModal = document.getElementById("exportModal");
const exportTableContainer = document.getElementById("exportTableContainer");
const copyExportBtn = document.getElementById("copyExportBtn");
const closeExportBtn = document.getElementById("closeExportBtn");
const searchOperatorInput = document.getElementById("searchOperator");
const searchOperatorSelect = document.getElementById("searchOperatorSelect");


let chartInstance = null;
let ALL_OPERATORS = [];      // { name, domains:{ key:{status,org,num,deb,fin} } }
let currentStatsGlobal = null; // stats par domaine pour tout le fichier

document.getElementById("openFileBtn").addEventListener("click", () => {
  document.getElementById("excelFile").click();
});

/* ==========
   Chargement fichier
   ========== */

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  showLoading();

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, {type:"binary", cellDates:true});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
    processRows(rows);
    hideLoading();
  };
  reader.readAsBinaryString(file);
});

/* ==========
   Barre de chargement
   ========== */

function showLoading(){
  loadingBarWrapper.style.display = "block";
  loadingBar.style.width = "0%";
  setTimeout(()=>loadingBar.style.width="60%",100);
}
function hideLoading(){
  loadingBar.style.width = "100%";
  setTimeout(()=>loadingBarWrapper.style.display="none",500);
}

/* ==========
   Traitement des lignes et calcul des stats globales
   ========== */

function processRows(rows){
  ALL_OPERATORS = [];
  tbody.innerHTML = "";

  let totalOps = 0;
  let expiredOps = 0;
  let fullCoreOps = 0;

  const stats = {};
  DOMAINS.forEach(d => stats[d.label] = {valid:0, expired:0, none:0});

  // Pour construire la liste des certificateurs
  const certSet = new Set();

  rows.slice(1).forEach(row => {
    const name = (row[COL.NAME] || "")
    .toString()
    .trim()
    .replace(/\s+/g, " ");    // normalise espaces

    if (!name) return;

    totalOps++;

    let opExpired = false;
    let opFullCore = true;

    const op = {
      name,
      row,
      domains: {}
    };

    DOMAINS.forEach(domain => {
      let status = "none";
      let org = "â€”";
      let num = "â€”";
      let deb = null;
      let fin = null;

      if (domain.audit != null) {
        const flag = row[domain.audit];
        if (flag) {
          status = "valid";
          org = flag.toString().trim() || "OK";
          stats[domain.label].valid++;
        } else {
          status = "none";
          stats[domain.label].none++;
        }
      } else {
        org = (row[domain.cert] || "").toString().trim() || "â€”";
        num = (row[domain.num] || "").toString().trim() || "â€”";
        deb = parseExcelDate(row[domain.deb]);
        fin = parseExcelDate(row[domain.fin]);

        const hasData = (org !== "â€”" || num !== "â€”" || deb || fin);

        if (!hasData) {
          status = "none";
          stats[domain.label].none++;
          if (domain.isCore) opFullCore = false;
        } else if (fin && !isValidDate(fin)) {
          status = "expired";
          stats[domain.label].expired++;
          opExpired = true;
          if (domain.isCore) opFullCore = false;
        } else {
          status = "valid";
          stats[domain.label].valid++;
        }
      }

      if (org && org !== "â€”") {
        certSet.add(org);
      }

      op.domains[domain.key] = {status, org, num, deb, fin};
    });

    if (opExpired) expiredOps++;
    if (opFullCore) fullCoreOps++;

    ALL_OPERATORS.push(op);
  });

  // KPI et stats globales
  kpiTotal.textContent = totalOps;
  kpiExpired.textContent = expiredOps;
  kpiFull.textContent = fullCoreOps;

currentStatsGlobal = stats;

populateCertFilter(certSet);

// ðŸŸ¦ Correction : peupler la liste des opÃ©rateurs APRÃˆS tout le traitement
populateOperatorSearch(ALL_OPERATORS);
console.log("Operators loaded:", ALL_OPERATORS.length);

drawChart();
applyFilters();
      // applique filtres (expiration + cert + opÃ©rateur) sur le tableau
}
function populateOperatorSearch(ops) {
  const select = searchOperatorSelect;
  select.innerHTML = '<option value="ALL">Tous</option>';

  const sortedNames = ops.map(o => o.name).sort((a, b) => a.localeCompare(b));

  sortedNames.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });
}


/* ==========
   Construction du filtre certificateur
   ========== */

function populateCertFilter(certSet){
  // reset
  filterCertSelect.innerHTML = '<option value="ALL">Tous</option>';

  const certs = Array.from(certSet).sort((a,b)=>a.localeCompare(b));
  certs.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    filterCertSelect.appendChild(opt);
  });
}

/* ==========
   Rendu du tableau Ã  partir d'une liste d'opÃ©rateurs
   ========== */

function renderTable(operators){
  tbody.innerHTML = "";

  operators.forEach(op => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${op.name}</td>`;

    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key] || {
        status:"none", org:"â€”", num:"â€”", deb:null, fin:null
      };

      const dDeb = d.deb ? d.deb.toLocaleDateString() : "â€”";
      const dFin = d.fin ? d.fin.toLocaleDateString() : "â€”";

      let tooltip = `${domain.label}
Certificateur : ${d.org}
NumÃ©ro : ${d.num}
DÃ©but : ${dDeb}
Fin : ${dFin}`;

      if (domain.key === "audit") {
        tooltip = (d.status === "valid")
          ? "Audit : CertifiÃ© (AW rempli)"
          : "Audit : Non certifiÃ©";
      }

      const td = document.createElement("td");
      const safeOrg = d.org === "" ? "â€”" : d.org;

      td.innerHTML = `
        <div class="cell-content">
          <span class="dot ${d.status}" title="${tooltip}"></span>
          <span class="cert-org ${d.status}" title="${tooltip}" data-cert="${safeOrg}">${safeOrg}</span>
        </div>
      `;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // Ajout du clic sur les certificateurs pour filtrer
  document.querySelectorAll(".cert-org").forEach(span => {
    const cert = span.getAttribute("data-cert");
    if (cert && cert !== "â€”") {
      span.style.cursor = "pointer";
      span.addEventListener("click", () => {
        filterCertSelect.value = cert;
        applyFilters();
      });
    }
  });
}

/* ==========
   Stats par certificateur
   ========== */

function computeStatsByCertificateur(){
  const stats = {};  // { "AFNOR": {valid,expired,none}, ... }

  ALL_OPERATORS.forEach(op => {
    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) return;
      const org = d.org;
      if (!org || org === "â€”") return;

      if (!stats[org]) {
        stats[org] = {valid:0, expired:0, none:0};
      }
      stats[org][d.status]++;
    });
  });

  return stats;
}

/* ==========
   Graph global : par domaine / par certificateur
   ========== */

function drawChart(){
  if (!currentStatsGlobal) return;

  const mode = graphModeSelect.value;

  if (chartInstance) chartInstance.destroy();

  let labels = [];
  let validData = [];
  let expiredData = [];
  let noneData = [];

  if (mode === "domain") {
    labels = DOMAINS.map(d => d.label);
    validData   = labels.map(l => currentStatsGlobal[l].valid);
    expiredData = labels.map(l => currentStatsGlobal[l].expired);
    noneData    = labels.map(l => currentStatsGlobal[l].none);
  } else if (mode === "cert") {
    const certStats = computeStatsByCertificateur();
    labels = Object.keys(certStats).sort((a,b)=>a.localeCompare(b));
    validData   = labels.map(c => certStats[c].valid);
    expiredData = labels.map(c => certStats[c].expired);
    noneData    = labels.map(c => certStats[c].none);
  }

  chartInstance = new Chart(chartCanvas.getContext("2d"), {
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"Valide", data:validData, backgroundColor:"#2ecc71"},
        {label:"ExpirÃ©e", data:expiredData, backgroundColor:"#e74c3c"},
        {label:"Aucune", data:noneData, backgroundColor:"#bdc3c7"}
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"bottom" } },
      scales:{ x:{ stacked:true }, y:{ stacked:true } }
    }
  });
}

/* ==========
   Application combinÃ©e des filtres (expiration + certificateur)
   ========== */

function applyFilters(){
  if (!ALL_OPERATORS.length) return;

  const months = parseInt(filterSelect.value, 10);
  const certVal = filterCertSelect.value;
  const searchText = searchOperatorInput.value.trim().toLowerCase();

  let ops = ALL_OPERATORS.slice();

  // 1) Filtre par nom d'opÃ©rateur (champ texte ou sÃ©lection)
  if (searchText !== "") {
    ops = ops.filter(op => op.name.toLowerCase().includes(searchText));
  }

  // 2) Filtre expiration
  if (months > 0) {
    const today = new Date();
    today.setHours(0,0,0,0);
    const target = new Date(today.getTime());
    target.setMonth(target.getMonth() + months);

    ops = ops.filter(op => {
      return Object.values(op.domains).some(d => {
        if (!d.fin) return false;
        const fin = d.fin;
        return fin >= today && fin <= target;
      });
    });
  }

  // 3) Filtre certificateur
  if (certVal !== "ALL") {
    ops = ops.filter(op => {
      return Object.values(op.domains).some(d => d.org === certVal);
    });
  }
// KPI filtrÃ©s
document.getElementById("kpiFilteredTotal").textContent = ops.length;

const expiredFiltered = ops.filter(op =>
  Object.values(op.domains).some(d => d.status === "expired")
).length;

document.getElementById("kpiFilteredExpired").textContent = expiredFiltered;

const fullFiltered = ops.filter(op =>
  DOMAINS.filter(d => d.isCore).every(d => op.domains[d.key].status === "valid")
).length;

document.getElementById("kpiFilteredFull").textContent = fullFiltered;

  renderTable(ops);
}


/* ==========
   Export visuel (1 ligne par opÃ©rateur)
   ========== */

function buildOperatorExportTable(operators){
  let html = `
    <table border="1" cellpadding="5" style="border-collapse:collapse;width:100%;font-size:12px;">
      <thead>
        <tr>
          <th>OpÃ©rateur</th>
          <th>Amiante</th>
          <th>CREP</th>
          <th>Termites</th>
          <th>DPE Mention</th>
          <th>Gaz</th>
          <th>Ã‰lec</th>
          <th>DPE Indiv</th>
          <th>Audit</th>
        </tr>
      </thead>
      <tbody>
  `;

  operators.forEach(op => {
    html += `<tr><td><b>${op.name}</b></td>`;

    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) {
        html += "<td>â€”</td>";
        return;
      }

      const dDeb = d.deb ? d.deb.toLocaleDateString() : "â€”";
      const dFin = d.fin ? d.fin.toLocaleDateString() : "â€”";

      html += `
        <td>
          <b>${d.status.toUpperCase()}</b><br>
          Certif : ${d.org || "â€”"}<br>
          Num : ${d.num || "â€”"}<br>
          DÃ©but : ${dDeb}<br>
          Fin : ${dFin}
        </td>`;
    });

    html += `</tr>`;
  });

  html += `</tbody></table>`;
  return html;
}

function openExportVisual(){
  const rows = Array.from(document.querySelectorAll("#dataTable tbody tr"));
  if (rows.length === 0){
    alert("Aucune donnÃ©e Ã  exporter.");
    return;
  }

  const ops = [];
  rows.forEach(tr => {
    const name = tr.children[0].innerText.trim();
    const op = ALL_OPERATORS.find(o => o.name === name);
    if (op) ops.push(op);
  });

  const tableHTML = buildOperatorExportTable(ops);
  exportTableContainer.innerHTML = tableHTML;

  exportModal.style.display = "flex";
}

function copyExportTable(){
  const htmlTable = exportTableContainer.innerHTML;

  if (!navigator.clipboard) {
    alert("Votre navigateur ne supporte pas la copie HTML.");
    return;
  }

  const blob = new Blob([htmlTable], { type: "text/html" });

  navigator.clipboard.write([
    new ClipboardItem({
      "text/html": blob
    })
  ])
  .then(() => {
    alert("Tableau copiÃ© avec mise en forme ! Vous pouvez coller dans Excel pour exploiter les donnÃ©es.");
  })
  .catch(err => {
    alert("Erreur de copie. SÃ©lectionnez et copiez manuellement.");
    console.error(err);
  });
}


/* ==========
   Ã‰couteurs filtres & mode graphique & export
   ========== */

filterSelect.addEventListener("change", applyFilters);
filterCertSelect.addEventListener("change", applyFilters);

graphModeSelect.addEventListener("change", () => {
  if (!currentStatsGlobal) return;
  drawChart();
});

// Affichage / masquage du graphique
document.getElementById("toggleChart").addEventListener("change", (e) => {
  const chartContainer = document.getElementById("chartContainer");

  if (e.target.checked) {
    chartContainer.style.display = "block";
    if (currentStatsGlobal) drawChart(); // redessine au besoin
  } else {
    chartContainer.style.display = "none";
  }
});


exportVisualBtn.addEventListener("click", openExportVisual);
copyExportBtn.addEventListener("click", copyExportTable);
closeExportBtn.addEventListener("click", () => {
  exportModal.style.display = "none";
});
// Recherche opÃ©rateur (saisie texte)
searchOperatorInput.addEventListener("input", (e) => {
  // quand on tape Ã  la main, on remet le select sur "Tous"
  searchOperatorSelect.value = "ALL";
  applyFilters();
});

// Recherche opÃ©rateur (sÃ©lecteur)
searchOperatorSelect.addEventListener("change", (e) => {
  const val = e.target.value;
  if (val === "ALL") {
    searchOperatorInput.value = "";
  } else {
    searchOperatorInput.value = val;
  }
  applyFilters();
});

/* ==========
   Tri par domaine (clic sur l'en-tÃªte)
   ========== */

const sortOrder = { expired:0, valid:1, none:2 };

function sortByDomain(domainKey){
  const domainIndex = DOMAINS.findIndex(d => d.key === domainKey);
  if (domainIndex < 0) return;

  const tdIndex = domainIndex + 1; // +1 car col 0 = nom

  const rows = Array.from(tbody.querySelectorAll("tr"));

  rows.sort((a,b) => {
    const aDot = a.children[tdIndex].querySelector(".dot");
    const bDot = b.children[tdIndex].querySelector(".dot");

    const aStatus = aDot ? aDot.classList[1] : "none";
    const bStatus = bDot ? bDot.classList[1] : "none";

    if (sortOrder[aStatus] !== sortOrder[bStatus]) {
      return sortOrder[aStatus] - sortOrder[bStatus];
    }

    const nameA = a.children[0].innerText.toLowerCase();
    const nameB = b.children[0].innerText.toLowerCase();
    return nameA.localeCompare(nameB);
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}

document.querySelectorAll("th[data-domain]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-domain");
    sortByDomain(key);
  });
});
</script>

</body>
</html>
