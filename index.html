<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Opérateurs – Certifications</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6fa; margin:0; padding:20px; }
  h1 { margin:0; }
  .container {
    width: 90%;
    max-width: 1200px;
    margin:auto;
  }

  input[type="file"] { margin:10px 0 15px; }

  /* Header avec logo */
  .header {
    display:flex;
    align-items:center;
    gap:20px;
    margin-bottom:10px;
  }
  .header-logo {
    height:48px;
    width:auto;
  }
  @media (max-width:600px){
    .header {
      flex-direction:column;
      text-align:center;
    }
    .header-logo {
      height:40px;
    }
  }

  /* Boutons de fichier */
  .file-button-wrapper {
    margin: 15px 0;
    position: relative;
  }

  #excelFile, #excelLocation {
    display: none; /* on cache l'input natif */
  }

  .primary-btn, .secondary-btn {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    border: none;
    transition: 0.2s;
    display:inline-block;
  }
  .primary-btn {
    background: #0078d4;
    color: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  .primary-btn:hover {
    background: #005fa3;
    box-shadow: 0 5px 12px rgba(0,0,0,0.25);
  }

  .secondary-btn {
    background:#ffffff;
    color:#0078d4;
    border:1px solid #0078d4;
    box-shadow:0 3px 8px rgba(0,0,0,0.05);
    margin-left:10px;
  }
  .secondary-btn:hover {
    background:#e8f3ff;
    box-shadow:0 5px 12px rgba(0,0,0,0.15);
  }

  /* Barre de chargement */
  #loadingBarWrapper {
    width:100%; background:#ddd; border-radius:20px; height:14px;
    margin:15px 0; display:none; overflow:hidden;
  }
  #loadingBar {
    height:100%; width:0; background:#4a90e2;
    border-radius:20px; transition:width .4s;
  }

  /* --- BARRE DE FILTRES MODERNE --- */
  .filters-card {
    background: white;
    padding: 18px 22px;
    border-radius: 14px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    margin: 10px 0 20px;
  }

  .filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 18px 30px;
    align-items: center;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    font-size: 13px;
  }

  .filter-group label {
    font-weight: bold;
    margin-bottom: 4px;
  }

  .filters select {
    appearance: none;
    padding: 7px 35px 7px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #fff;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23000" height="14" viewBox="0 0 20 20" width="14" xmlns="http://www.w3.org/2000/svg"><path d="M5.516 7.548L10 12.032l4.484-4.484L16 8.064l-6 6-6-6z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    cursor: pointer;
  }

  .filters button {
    padding: 8px 18px;
    background: #0078d4;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: 0.2s;
  }

  .filters button:hover {
    background: #005fa3;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  @media (max-width: 900px) {
    .filters-row {
      flex-direction: column;
      align-items: stretch;
    }
  }

  /* KPI */
  .kpi-card {
    background:white;
    padding:18px 22px;
    border-radius:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    margin-bottom:25px;
  }

  .kpi-container {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin: 20px 0 30px;
  }

  .kpi-card {
    flex: 1;
    border-left: 5px solid #0078d4;
    min-width: 260px;
  }

  .kpi-title {
    font-weight: 700;
    font-size: 15px;
    color: #005fa3;
    margin-bottom: 10px;
    text-transform: uppercase;
  }

  .kpi-line {
    font-size: 15px;
    margin: 6px 0;
    display: flex;
    justify-content: space-between;
  }

  .kpi-value {
    font-weight: bold;
    color: #222;
  }

  @media (max-width: 900px) {
    .kpi-container {
      flex-direction: column;
    }
  }

  /* Graph */
  #chartContainer {
    background:white; padding:20px; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:30px;
    display:none; /* masqué par défaut */
  }

  .chart-controls {
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
    font-size:13px;
  }

  .chart-controls label {
    font-weight:bold;
  }

  /* Tableau */
  table {
    width: 90%;
    margin: auto;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  th, td { padding:10px 12px; border-bottom:1px solid #eee; font-size:13px; }
  th { background:#fafafa; cursor:pointer; }
  th:hover { background:#ececec; }

  .cell-content { display:flex; align-items:center; gap:6px; }
  .dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
  .valid { background:#2ecc71; }
  .expired { background:#e74c3c; }
  .none { background:#bdc3c7; }

  .cert-org {
    font-size:11px; padding:2px 6px; border-radius:4px;
    max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .cert-org.valid { background:#e8f8f0; color:#1e8449; }
  .cert-org.expired { background:#fdecea; color:#c0392b; }
  .cert-org.none { background:#ecf0f1; color:#7f8c8d; }

  .hide-cert .cert-org {
    display:none !important;
  }

  /* Colonnes géographiques : mode hybride (masquées par défaut) */
  th.geo-col, td.geo-col {
    display:none;
  }
  #dataTable.show-geo th.geo-col,
  #dataTable.show-geo td.geo-col {
    display:table-cell;
  }

  /* Zone actions tableau */
  .table-actions {
    width:90%;
    margin: 10px auto 5px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  .table-actions button {
    padding: 8px 16px;
    border-radius: 8px;
    border:none;
    cursor:pointer;
    font-size: 13px;
    font-weight:600;
    background:#0078d4;
    color:white;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    transition:0.2s;
  }

  .table-actions button:hover {
    background:#005fa3;
    box-shadow:0 4px 10px rgba(0,0,0,0.25);
  }

  /* Modal export visuel */
  #exportModal {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.45); display:none;
    align-items:center; justify-content:center; z-index:9999;
  }
  #exportModal .modal-inner {
    background:white; padding:20px; border-radius:12px;
    width:90%; max-width:none; max-height:85%; overflow:auto;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
  }
  #exportModal h2 {
    margin-top:0;
  }
  #exportModal table {
    box-shadow:none;
  }
  #exportModal button {
    margin-top:10px;
    margin-right:8px;
  }
  #exportModal button {
    padding: 6px 14px;
    background: #0078d4;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 13px;
    margin-left: 6px;
  }
  #exportModal button:hover {
    background:#005fa3;
  }

  /* Recherche opérateur */
  #searchOperator {
    padding: 7px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 5px;
  }

  #searchOperatorSelect {
    padding: 7px 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  #toggleChart, #toggleGeoCols {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <img src="https://raw.githubusercontent.com/lioneltissotbez-socotec/socotec-assets/8b85d1f9144eefe32a8ddca9516b8d8583d7bbbd/logo.svg"
         alt="Logo SOCOTEC" class="header-logo">
    <h1>Dashboard des opérateurs – Certifications</h1>
  </div>

  <div class="file-button-wrapper">
    <button id="openFileBtn" class="primary-btn">Ouvrir le fichier opérateurs</button>
    <input type="file" id="excelFile" accept=".xlsx" />
    <button id="openLocationBtn" class="secondary-btn">Ouvrir le fichier géographique (optionnel)</button>
    <input type="file" id="excelLocation" accept=".xlsx" />
  </div>

  <!-- Filtres modernisés -->
  <div class="filters-card filters">
    <div class="filters-row">

      <div class="filter-group">
        <label for="filterExpiry">Expiration</label>
        <select id="filterExpiry">
          <option value="0">Tous</option>
          <option value="1">1 mois</option>
          <option value="3">3 mois</option>
          <option value="6">6 mois</option>
          <option value="12">12 mois</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filterCert">Certificateur</label>
        <select id="filterCert">
          <option value="ALL">Tous</option>
        </select>
      </div>

      <!-- Filtres géographiques -->
      <div class="filter-group">
        <label for="filterPole">Pôle budgétaire</label>
        <select id="filterPole">
          <option value="ALL">Tous</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filterSection">Section budgétaire</label>
        <select id="filterSection">
          <option value="ALL">Toutes</option>
        </select>
      </div>

      <!-- Recherche opérateur -->
      <div class="filter-group">
        <label for="searchOperator">Opérateur</label>
        <input type="text" id="searchOperator" placeholder="Nom ou prénom…" />
        <select id="searchOperatorSelect">
          <option value="ALL">Tous</option>
        </select>
      </div>

      <div class="filter-group" style="margin-top:22px;">
        <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="toggleChart" />
          Afficher le graphique
        </label>
      </div>

      <div class="filter-group" style="margin-top:22px;">
        <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="toggleGeoCols" />
          Colonnes géographiques
        </label>
      </div>

      <div class="filter-group" style="margin-top:22px;">
        <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="toggleCert" />
          Afficher certificateurs
        </label>
      </div>

    </div>
  </div>

  <div id="loadingBarWrapper"><div id="loadingBar"></div></div>

  <!-- KPI -->
  <div class="kpi-container">

    <div class="kpi-card">
      <div class="kpi-title">Opérateurs</div>
      <div class="kpi-line">Globaux <span class="kpi-value" id="kpiTotal">–</span></div>
      <div class="kpi-line">Filtrés <span class="kpi-value" id="kpiFilteredTotal">–</span></div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Expirés</div>
      <div class="kpi-line">Globaux <span class="kpi-value" id="kpiExpired">–</span></div>
      <div class="kpi-line">Filtrés <span class="kpi-value" id="kpiFilteredExpired">–</span></div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Socle complet</div>
      <div class="kpi-line">Globaux <span class="kpi-value" id="kpiFull">–</span></div>
      <div class="kpi-line">Filtrés <span class="kpi-value" id="kpiFilteredFull">–</span></div>
    </div>

  </div>

  <div id="chartContainer">
    <div class="chart-controls">
      <label for="graphMode">Vue graphique</label>
      <select id="graphMode">
        <option value="domain">Domaines</option>
        <option value="cert">Certificateurs</option>
        <option value="pole">Pôles</option>
        <option value="section">Sections</option>
      </select>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div class="table-actions">
    <button id="exportVisualBtn">Exporter le tableau</button>
    <button id="exportEmailsBtn">Export des emails</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Opérateur</th>
        <th data-domain="amiante">Amiante</th>
        <th data-domain="crep">CREP</th>
        <th data-domain="term">Termites</th>
        <th data-domain="dpem">DPE Mention</th>
        <th data-domain="gaz">Gaz</th>
        <th data-domain="elec">Élec</th>
        <th data-domain="dpei">DPE Indiv</th>
        <th data-domain="audit">Audit</th>
        <th class="geo-col">Pôle</th>
        <th class="geo-col">Section</th>
        <th class="geo-col">Manager</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- MODAL EXPORT VISUEL -->
<div id="exportModal">
  <div class="modal-inner">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h2 style="margin:0;">Export des opérateurs filtrés</h2>
      <div>
        <button id="copyExportBtn">Copier</button>
        <button id="closeExportBtn">Fermer</button>
      </div>
    </div>
    <div id="exportTableContainer"></div>
  </div>
</div>

<script>
/* ==========
   Utilitaires dates
   ========== */

function parseExcelDate(v) {
  if (!v) return null;

  if (v instanceof Date) return v;

  if (typeof v === "number") {
    const d = XLSX.SSF.parse_date_code(v);
    if (!d) return null;
    return new Date(d.y, d.m - 1, d.d);
  }

  if (typeof v === "string") {
    const parts = v.split("/");
    if (parts.length === 3) {
      const [dd, mm, yyyy] = parts.map(n => parseInt(n));
      if (!isNaN(dd) && !isNaN(mm) && !isNaN(yyyy)) {
        return new Date(yyyy, mm - 1, dd);
      }
    }
  }
  return null;
}

function isValidDate(dateFin) {
  const d = parseExcelDate(dateFin);
  if (!d) return false;
  const today = new Date();
  today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  return d >= today;
}

/* ==========
   Normalisation / clés de jointure
   ========== */

function normalizeString(str) {
  if (!str) return "";

  return str
    .toString()
    .normalize("NFD").replace(/[̀-ͯ]/g, "")
    .replace(/[-'_]+/g, " ")
    .replace(/[^A-Za-z0-9 ]+/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .toUpperCase();
}

// Clé depuis une ligne du fichier géographique : Nom (B) + Prénom (C)
function getGeoKeyFromRow(row) {
  const nom = row[1] || "";
  const prenom = row[2] || "";
  return normalizeString(nom + " " + prenom);
}

// Clé depuis un opérateur (en priorité colonnes C = NOM, D = Prénom)
function getGeoKeyFromOperator(op) {
  const r = op.row || [];
  const nom = r[2] || "";
  const prenom = r[3] || "";

  const direct = normalizeString(nom + " " + prenom);     // NOM PRÉNOM
  const reversed = normalizeString(prenom + " " + nom);   // PRÉNOM NOM

  if (nom || prenom) {
    if (LOCATION_MAP[direct]) return direct;
    if (LOCATION_MAP[reversed]) return reversed;
    return direct;
  }

  const parts = (op.name || "").split(" ").filter(x => x.trim() !== "");
  if (parts.length >= 2) {
    const last = parts[parts.length - 1];
    const first = parts.slice(0, -1).join(" ");
    const p_direct = normalizeString(last + " " + first);
    const p_reversed = normalizeString(first + " " + last);

    if (LOCATION_MAP[p_direct]) return p_direct;
    if (LOCATION_MAP[p_reversed]) return p_reversed;

    return p_direct;
  }

  return normalizeString(op.name || "");
}

/* ==========
   Config colonnes / domaines
   ========== */

const COL = {
  NAME:1,

  AMI_CERT:10, AMI_NUM:11, AMI_DEB:12, AMI_FIN:13,
  CREP_CERT:15, CREP_NUM:16, CREP_DEB:17, CREP_FIN:18,
  TERM_CERT:20, TERM_NUM:21, TERM_DEB:22, TERM_FIN:23,
  DPEM_CERT:25, DPEM_NUM:26, DPEM_DEB:27, DPEM_FIN:28,
  GAZ_CERT:30, GAZ_NUM:31, GAZ_DEB:32, GAZ_FIN:33,
  ELEC_CERT:35, ELEC_NUM:36, ELEC_DEB:37, ELEC_FIN:38,
  DPEI_CERT:42, DPEI_NUM:43, DPEI_DEB:44, DPEI_FIN:45,
  AUDIT:48
};

const DOMAINS = [
  {label:"Amiante",     key:"amiante", isCore:true,
    cert:COL.AMI_CERT,  num:COL.AMI_NUM,  deb:COL.AMI_DEB,  fin:COL.AMI_FIN},
  {label:"CREP",        key:"crep",    isCore:true,
    cert:COL.CREP_CERT, num:COL.CREP_NUM, deb:COL.CREP_DEB, fin:COL.CREP_FIN},
  {label:"Termites",    key:"term",    isCore:true,
    cert:COL.TERM_CERT, num:COL.TERM_NUM, deb:COL.TERM_DEB, fin:COL.TERM_FIN},
  {label:"DPE Mention", key:"dpem",    isCore:true,
    cert:COL.DPEM_CERT, num:COL.DPEM_NUM, deb:COL.DPEM_DEB, fin:COL.DPEM_FIN},
  {label:"Gaz",         key:"gaz",     isCore:true,
    cert:COL.GAZ_CERT,  num:COL.GAZ_NUM,  deb:COL.GAZ_DEB,  fin:COL.GAZ_FIN},
  {label:"Élec",        key:"elec",    isCore:true,
    cert:COL.ELEC_CERT, num:COL.ELEC_NUM, deb:COL.ELEC_DEB, fin:COL.ELEC_FIN},
  {label:"DPE Indiv",   key:"dpei",    isCore:false,
    cert:COL.DPEI_CERT, num:COL.DPEI_NUM, deb:COL.DPEI_DEB, fin:COL.DPEI_FIN},
  {label:"Audit",       key:"audit",   isCore:false,
    audit:COL.AUDIT}
];

/* ==========
   Références DOM et variables globales
   ========== */

const fileInput = document.getElementById("excelFile");
const locationFileInput = document.getElementById("excelLocation");

const filterSelect = document.getElementById("filterExpiry");
const filterCertSelect = document.getElementById("filterCert");
const filterPoleSelect = document.getElementById("filterPole");
const filterSectionSelect = document.getElementById("filterSection");

const graphModeSelect = document.getElementById("graphMode");
const loadingBarWrapper = document.getElementById("loadingBarWrapper");
const loadingBar = document.getElementById("loadingBar");
const tbody = document.querySelector("#dataTable tbody");
const kpiTotal = document.getElementById("kpiTotal");
const kpiExpired = document.getElementById("kpiExpired");
const kpiFull = document.getElementById("kpiFull");
const chartCanvas = document.getElementById("chart");
const exportVisualBtn = document.getElementById("exportVisualBtn");
const exportEmailsBtn = document.getElementById("exportEmailsBtn");
const exportModal = document.getElementById("exportModal");
const exportTableContainer = document.getElementById("exportTableContainer");
const copyExportBtn = document.getElementById("copyExportBtn");
const closeExportBtn = document.getElementById("closeExportBtn");
const searchOperatorInput = document.getElementById("searchOperator");
const searchOperatorSelect = document.getElementById("searchOperatorSelect");
const toggleGeoColsCheckbox = document.getElementById("toggleGeoCols");
const toggleCert = document.getElementById("toggleCert");

let chartInstance = null;
let ALL_OPERATORS = [];      // { name, row, domains:{ key:{status,org,num,deb,fin} }, pole, section, manager, email }
let currentStatsGlobal = null; // stats par domaine pour tout le fichier
let LOCATION_MAP = {};       // key -> { email, section, pole, manager }
let HAS_LOCATION = false;

document.getElementById("openFileBtn").addEventListener("click", () => {
  fileInput.click();
});
document.getElementById("openLocationBtn").addEventListener("click", () => {
  locationFileInput.click();
});

/* ==========
   Chargement fichier opérateurs
   ========== */

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  showLoading();

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, {type:"binary", cellDates:true});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
    processRows(rows);
    hideLoading();
  };
  reader.readAsBinaryString(file);
});

/* ==========
   Chargement fichier géographique
   ========== */

locationFileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, {type:"binary", cellDates:true});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
    buildLocationMap(rows);
    HAS_LOCATION = true;

    if (ALL_OPERATORS.length) {
      attachLocationToAllOperators();
      populateLocationFilters(ALL_OPERATORS);
      applyFilters();
    }
  };
  reader.readAsBinaryString(file);
});

function buildLocationMap(rows) {
  LOCATION_MAP = {};

  rows.slice(1).forEach(row => {
    const nom = row[1];
    const prenom = row[2];
    if (!nom && !prenom) return;

    const email = row[3] || "";
    const section = row[4] || "—";
    const pole = row[5] || "—";
    const managerNom = row[6] || "";
    const managerPrenom = row[7] || "";
    const manager = (managerNom + " " + managerPrenom).trim() || "—";

    const key = getGeoKeyFromRow(row);
    LOCATION_MAP[key] = { email, section, pole, manager };
  });
}

/* ==========
   Barre de chargement
   ========== */

function showLoading(){
  loadingBarWrapper.style.display = "block";
  loadingBar.style.width = "0%";
  setTimeout(()=>loadingBar.style.width="60%",100);
}
function hideLoading(){
  loadingBar.style.width = "100%";
  setTimeout(()=>loadingBarWrapper.style.display="none",500);
}

/* ==========
   Traitement des lignes opérateurs
   ========== */

function processRows(rows){
  ALL_OPERATORS = [];
  tbody.innerHTML = "";

  let totalOps = 0;
  let expiredOps = 0;
  let fullCoreOps = 0;

  const stats = {};
  DOMAINS.forEach(d => stats[d.label] = {valid:0, expired:0, none:0});

  const certSet = new Set();

  rows.slice(1).forEach(row => {
    const name = (row[COL.NAME] || "")
      .toString()
      .trim()
      .replace(/\s+/g, " ");

    if (!name) return;

    totalOps++;

    let opExpired = false;
    let opFullCore = true;

    const op = {
      name,
      row,
      domains: {},
      pole: "—",
      section: "—",
      manager: "—",
      email: ""
    };

    DOMAINS.forEach(domain => {
      let status = "none";
      let org = "—";
      let num = "—";
      let deb = null;
      let fin = null;

      if (domain.audit != null) {
        const flag = row[domain.audit];
        if (flag) {
          status = "valid";
          org = flag.toString().trim() || "OK";
          stats[domain.label].valid++;
        } else {
          status = "none";
          stats[domain.label].none++;
        }
      } else {
        org = (row[domain.cert] || "").toString().trim() || "—";
        num = (row[domain.num] || "").toString().trim() || "—";
        deb = parseExcelDate(row[domain.deb]);
        fin = parseExcelDate(row[domain.fin]);

        const hasData = (org !== "—" || num !== "—" || deb || fin);

        if (!hasData) {
          status = "none";
          stats[domain.label].none++;
          if (domain.isCore) opFullCore = false;
        } else if (fin && !isValidDate(fin)) {
          status = "expired";
          stats[domain.label].expired++;
          opExpired = true;
          if (domain.isCore) opFullCore = false;
        } else {
          status = "valid";
          stats[domain.label].valid++;
        }
      }

      if (org && org !== "—") {
        certSet.add(org);
      }

      op.domains[domain.key] = {status, org, num, deb, fin};
    });

    if (opExpired) expiredOps++;
    if (opFullCore) fullCoreOps++;

    ALL_OPERATORS.push(op);
  });

  // KPI globaux
  kpiTotal.textContent = totalOps;
  kpiExpired.textContent = expiredOps;
  kpiFull.textContent = fullCoreOps;

  currentStatsGlobal = stats;

  populateCertFilter(certSet);
  populateOperatorSearch(ALL_OPERATORS);

  if (HAS_LOCATION) {
    attachLocationToAllOperators();
    populateLocationFilters(ALL_OPERATORS);
  }

  drawChart();
  applyFilters();
}

function attachLocationToAllOperators() {
  ALL_OPERATORS.forEach(op => {
    const key = getGeoKeyFromOperator(op);
    const loc = LOCATION_MAP[key];

    if (loc) {
      op.email = loc.email || "";
      op.section = loc.section || "—";
      op.pole = loc.pole || "—";
      op.manager = loc.manager || "—";
    } else {
      op.email = "";
      op.section = "—";
      op.pole = "—";
      op.manager = "—";
    }
  });
}

function populateLocationFilters(ops) {
  const poles = new Set();
  const sections = new Set();

  ops.forEach(op => {
    if (op.pole && op.pole !== "—") poles.add(op.pole);
    if (op.section && op.section !== "—") sections.add(op.section);
  });

  filterPoleSelect.innerHTML = '<option value="ALL">Tous</option>';
  Array.from(poles).sort().forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    filterPoleSelect.appendChild(opt);
  });

  filterSectionSelect.innerHTML = '<option value="ALL">Toutes</option>';
  Array.from(sections).sort().forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    filterSectionSelect.appendChild(opt);
  });
}

function populateOperatorSearch(ops) {
  const select = searchOperatorSelect;
  select.innerHTML = '<option value="ALL">Tous</option>';

  const sortedNames = ops.map(o => o.name).sort((a, b) => a.localeCompare(b));

  sortedNames.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });
}

/* ==========
   Construction du filtre certificateur
   ========== */

function populateCertFilter(certSet){
  filterCertSelect.innerHTML = '<option value="ALL">Tous</option>';

  const certs = Array.from(certSet).sort((a,b)=>a.localeCompare(b));
  certs.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    filterCertSelect.appendChild(opt);
  });
}

/* ==========
   Rendu du tableau
   ========== */

function renderTable(operators){
  tbody.innerHTML = "";

  operators.forEach(op => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${op.name}</td>`;

    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key] || {
        status:"none", org:"—", num:"—", deb:null, fin:null
      };

      const dDeb = d.deb ? d.deb.toLocaleDateString() : "—";
      const dFin = d.fin ? d.fin.toLocaleDateString() : "—";

      let tooltip = `${domain.label}
Certificateur : ${d.org}
Numéro : ${d.num}
Début : ${dDeb}
Fin : ${dFin}`;

      if (domain.key === "audit") {
        tooltip = (d.status === "valid")
          ? "Audit : Certifié (AW rempli)"
          : "Audit : Non certifié";
      }

      const td = document.createElement("td");
      const safeOrg = d.org === "" ? "—" : d.org;

      td.innerHTML = `
        <div class="cell-content">
          <span class="dot ${d.status}" title="${tooltip}"></span>
          <span class="cert-org ${d.status}" title="${tooltip}" data-cert="${safeOrg}">${safeOrg}</span>
        </div>
      `;
      tr.appendChild(td);
    });

    const tdPole = document.createElement("td");
    tdPole.className = "geo-col";
    tdPole.textContent = op.pole || "—";
    tr.appendChild(tdPole);

    const tdSection = document.createElement("td");
    tdSection.className = "geo-col";
    tdSection.textContent = op.section || "—";
    tr.appendChild(tdSection);

    const tdManager = document.createElement("td");
    tdManager.className = "geo-col";
    tdManager.textContent = op.manager || "—";
    tr.appendChild(tdManager);

    tbody.appendChild(tr);
  });

  document.querySelectorAll(".cert-org").forEach(span => {
    const cert = span.getAttribute("data-cert");
    if (cert && cert !== "—") {
      span.style.cursor = "pointer";
      span.addEventListener("click", () => {
        filterCertSelect.value = cert;
        applyFilters();
      });
    }
  });
}

/* ==========
   Stats par certificateur / pôle / section
   ========== */

function computeStatsByCertificateur(){
  const stats = {};

  ALL_OPERATORS.forEach(op => {
    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) return;
      const org = d.org;
      if (!org || org === "—") return;

      if (!stats[org]) {
        stats[org] = {valid:0, expired:0, none:0};
      }
      stats[org][d.status]++;
    });
  });

  return stats;
}

function computeStatsByPole(){
  const stats = {};
  ALL_OPERATORS.forEach(op => {
    const pole = op.pole || "—";
    if (!stats[pole]) {
      stats[pole] = {valid:0, expired:0, none:0};
    }
    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) return;
      stats[pole][d.status]++;
    });
  });
  return stats;
}

function computeStatsBySection(){
  const stats = {};
  ALL_OPERATORS.forEach(op => {
    const section = op.section || "—";
    if (!stats[section]) {
      stats[section] = {valid:0, expired:0, none:0};
    }
    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) return;
      stats[section][d.status]++;
    });
  });
  return stats;
}

/* ==========
   Graph global : domaines / cert / pôle / section
   ========== */

function drawChart(){
  if (!currentStatsGlobal) return;

  const mode = graphModeSelect.value;

  if (chartInstance) chartInstance.destroy();

  let labels = [];
  let validData = [];
  let expiredData = [];
  let noneData = [];

  if (mode === "domain") {
    DOMAINS.forEach(d => {
      const s = currentStatsGlobal[d.label];
      if (!s) return;
      const total = s.valid + s.expired + s.none;
      if (total === 0) return;
      labels.push(d.label);
      validData.push(s.valid);
      expiredData.push(s.expired);
      noneData.push(s.none);
    });
  } else if (mode === "cert") {
    const certStats = computeStatsByCertificateur();
    Object.keys(certStats).sort((a,b)=>a.localeCompare(b)).forEach(c => {
      const s = certStats[c];
      const total = s.valid + s.expired + s.none;
      if (total === 0) return;
      labels.push(c);
      validData.push(s.valid);
      expiredData.push(s.expired);
      noneData.push(s.none);
    });
  } else if (mode === "pole") {
    const poleStats = computeStatsByPole();
    Object.keys(poleStats).sort((a,b)=>a.localeCompare(b)).forEach(p => {
      if (p === "—") return;
      const s = poleStats[p];
      const total = s.valid + s.expired + s.none;
      if (total === 0) return;
      labels.push(p);
      validData.push(s.valid);
      expiredData.push(s.expired);
      noneData.push(s.none);
    });
  } else if (mode === "section") {
    const sectionStats = computeStatsBySection();
    Object.keys(sectionStats).sort((a,b)=>a.localeCompare(b)).forEach(sKey => {
      if (sKey === "—") return;
      const s = sectionStats[sKey];
      const total = s.valid + s.expired + s.none;
      if (total === 0) return;
      labels.push(sKey);
      validData.push(s.valid);
      expiredData.push(s.expired);
      noneData.push(s.none);
    });
  }

  chartInstance = new Chart(chartCanvas.getContext("2d"), {
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"Valide", data:validData, backgroundColor:"#2ecc71"},
        {label:"Expirée", data:expiredData, backgroundColor:"#e74c3c"},
        {label:"Aucune", data:noneData, backgroundColor:"#bdc3c7"}
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ position:"bottom" } },
      scales:{ x:{ stacked:true }, y:{ stacked:true } }
    }
  });
}

/* ==========
   Application combinée des filtres
   ========== */

function applyFilters(){
  if (!ALL_OPERATORS.length) return;

  const months = parseInt(filterSelect.value, 10);
  const certVal = filterCertSelect.value;
  const searchText = searchOperatorInput.value.trim().toLowerCase();
  const poleVal = filterPoleSelect.value;
  const sectionVal = filterSectionSelect.value;

  let ops = ALL_OPERATORS.slice();

  if (searchText !== "") {
    ops = ops.filter(op => op.name.toLowerCase().includes(searchText));
  }

  if (months > 0) {
    const today = new Date();
    today.setHours(0,0,0,0);
    const target = new Date(today.getTime());
    target.setMonth(target.getMonth() + months);

    ops = ops.filter(op => {
      return Object.values(op.domains).some(d => {
        if (!d.fin) return false;
        const fin = d.fin;
        return fin >= today && fin <= target;
      });
    });
  }

  if (certVal !== "ALL") {
    ops = ops.filter(op => {
      return Object.values(op.domains).some(d => d.org === certVal);
    });
  }

  if (poleVal !== "ALL") {
    ops = ops.filter(op => op.pole === poleVal);
  }

  if (sectionVal !== "ALL") {
    ops = ops.filter(op => op.section === sectionVal);
  }

  document.getElementById("kpiFilteredTotal").textContent = ops.length;

  const expiredFiltered = ops.filter(op =>
    Object.values(op.domains).some(d => d.status === "expired")
  ).length;
  document.getElementById("kpiFilteredExpired").textContent = expiredFiltered;

  const fullFiltered = ops.filter(op =>
    DOMAINS.filter(d => d.isCore).every(d => op.domains[d.key].status === "valid")
  ).length;
  document.getElementById("kpiFilteredFull").textContent = fullFiltered;

  renderTable(ops);
}

/* ==========
   Export tableau
   ========== */

function buildOperatorExportTable(operators){
  let html = `
    <table border="1" cellpadding="5" style="border-collapse:collapse;width:100%;font-size:12px;">
      <thead>
        <tr>
          <th>Opérateur</th>
          <th>Amiante</th>
          <th>CREP</th>
          <th>Termites</th>
          <th>DPE Mention</th>
          <th>Gaz</th>
          <th>Élec</th>
          <th>DPE Indiv</th>
          <th>Audit</th>
          <th>Pôle</th>
          <th>Section</th>
          <th>Manager</th>
        </tr>
      </thead>
      <tbody>
  `;

  operators.forEach(op => {
    html += `<tr><td><b>${op.name}</b></td>`;

    DOMAINS.forEach(domain => {
      const d = op.domains[domain.key];
      if (!d) {
        html += "<td>—</td>";
        return;
      }

      const dDeb = d.deb ? d.deb.toLocaleDateString() : "—";
      const dFin = d.fin ? d.fin.toLocaleDateString() : "—";

      html += `
        <td>
          <b>${d.status.toUpperCase()}</b><br>
          Certif : ${d.org || "—"}<br>
          Num : ${d.num || "—"}<br>
          Début : ${dDeb}<br>
          Fin : ${dFin}
        </td>`;
    });

    html += `
      <td>${op.pole || "—"}</td>
      <td>${op.section || "—"}</td>
      <td>${op.manager || "—"}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  return html;
}

function getOperatorsFromCurrentTable(){
  const rows = Array.from(document.querySelectorAll("#dataTable tbody tr"));
  const ops = [];
  rows.forEach(tr => {
    const name = tr.children[0].innerText.trim();
    const op = ALL_OPERATORS.find(o => o.name === name);
    if (op) ops.push(op);
  });
  return ops;
}

function openExportVisual(){
  const ops = getOperatorsFromCurrentTable();
  if (!ops.length){
    alert("Aucune donnée à exporter.");
    return;
  }

  const tableHTML = buildOperatorExportTable(ops);
  exportTableContainer.innerHTML = tableHTML;

  exportModal.style.display = "flex";
}

function copyExportTable(){
  const htmlTable = exportTableContainer.innerHTML;

  if (!navigator.clipboard || !window.ClipboardItem) {
    alert("Votre navigateur ne supporte pas la copie HTML avec mise en forme. Vous pouvez sélectionner le tableau et le copier manuellement.");
    return;
  }

  const blob = new Blob([htmlTable], { type: "text/html" });

  navigator.clipboard.write([
    new ClipboardItem({
      "text/html": blob
    })
  ])
  .then(() => {
    alert("Tableau copié avec mise en forme ! Vous pouvez coller dans Excel ou Outlook.");
  })
  .catch(err => {
    alert("Erreur de copie. Sélectionnez et copiez manuellement.");
    console.error(err);
  });
}

/* ==========
   Export des emails
   ========== */

function exportEmails(){
  const ops = getOperatorsFromCurrentTable();
  if (!ops.length){
    alert("Aucune donnée à exporter.");
    return;
  }

  const emails = Array.from(new Set(
    ops
      .map(o => (o.email || "").trim())
      .filter(e => e !== "")
  ));

  if (!emails.length){
    alert("Aucun email disponible pour les opérateurs filtrés.");
    return;
  }

  const emailList = emails.join("; ");

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(emailList)
      .then(() => {
        alert("Liste d'emails copiée dans le presse-papiers :\n\n" + emailList);
      })
      .catch(() => {
        alert("Impossible de copier automatiquement. Voici la liste :\n\n" + emailList);
      });
  } else {
    alert("Voici la liste d'emails :\n\n" + emailList);
  }
}

/* ==========
   Toggle affichage des certificateurs
   ========== */

document.body.classList.add("hide-cert");

toggleCert.addEventListener("change", () => {
  if (toggleCert.checked) {
    document.body.classList.remove("hide-cert");
  } else {
    document.body.classList.add("hide-cert");
  }
});

/* ==========
   Écouteurs filtres & mode graphique & export
   ========== */

filterSelect.addEventListener("change", applyFilters);
filterCertSelect.addEventListener("change", applyFilters);
filterPoleSelect.addEventListener("change", applyFilters);
filterSectionSelect.addEventListener("change", applyFilters);

graphModeSelect.addEventListener("change", () => {
  if (!currentStatsGlobal) return;
  drawChart();
});

document.getElementById("toggleChart").addEventListener("change", (e) => {
  const chartContainer = document.getElementById("chartContainer");
  if (e.target.checked) {
    chartContainer.style.display = "block";
    if (currentStatsGlobal) drawChart();
  } else {
    chartContainer.style.display = "none";
  }
});

toggleGeoColsCheckbox.addEventListener("change", (e) => {
  const table = document.getElementById("dataTable");
  if (e.target.checked) {
    table.classList.add("show-geo");
  } else {
    table.classList.remove("show-geo");
  }
});

exportVisualBtn.addEventListener("click", openExportVisual);
copyExportBtn.addEventListener("click", copyExportTable);
closeExportBtn.addEventListener("click", () => {
  exportModal.style.display = "none";
});
exportEmailsBtn.addEventListener("click", exportEmails);

searchOperatorInput.addEventListener("input", (e) => {
  searchOperatorSelect.value = "ALL";
  applyFilters();
});

searchOperatorSelect.addEventListener("change", (e) => {
  const val = e.target.value;
  if (val === "ALL") {
    searchOperatorInput.value = "";
  } else {
    searchOperatorInput.value = val;
  }
  applyFilters();
});

/* ==========
   Tri par domaine (clic sur l'en-tête)
   ========== */

const sortOrder = { expired:0, valid:1, none:2 };

function sortByDomain(domainKey){
  const domainIndex = DOMAINS.findIndex(d => d.key === domainKey);
  if (domainIndex < 0) return;

  const tdIndex = domainIndex + 1;

  const rows = Array.from(tbody.querySelectorAll("tr"));

  rows.sort((a,b) => {
    const aDot = a.children[tdIndex].querySelector(".dot");
    const bDot = b.children[tdIndex].querySelector(".dot");

    const aStatus = aDot ? aDot.classList[1] : "none";
    const bStatus = bDot ? bDot.classList[1] : "none";

    if (sortOrder[aStatus] !== sortOrder[bStatus]) {
      return sortOrder[aStatus] - sortOrder[bStatus];
    }

    const nameA = a.children[0].innerText.toLowerCase();
    const nameB = b.children[0].innerText.toLowerCase();
    return nameA.localeCompare(nameB);
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}

document.querySelectorAll("th[data-domain]").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-domain");
    sortByDomain(key);
  });
});

/* ==========
   Tri par colonnes géographiques
   ========== */

function sortByGeoHeader(th){
  const thIndex = Array.from(th.parentNode.children).indexOf(th);
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const asc = th.dataset.sortAsc === "true" ? false : true;
  th.dataset.sortAsc = asc ? "true" : "false";

  rows.sort((a,b) => {
    const aVal = a.children[thIndex].innerText.toLowerCase();
    const bVal = b.children[thIndex].innerText.toLowerCase();

    if (aVal < bVal) return asc ? -1 : 1;
    if (aVal > bVal) return asc ? 1 : -1;

    const nameA = a.children[0].innerText.toLowerCase();
    const nameB = b.children[0].innerText.toLowerCase();
    return nameA.localeCompare(nameB);
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}

document.querySelectorAll("#dataTable thead th.geo-col").forEach(th => {
  th.addEventListener("click", () => sortByGeoHeader(th));
});
</script>

</body>
</html>
